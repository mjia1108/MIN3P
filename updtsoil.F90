!*****Revision Informations Automatically Generated by VisualSVN*****!
!---------------------------------------------------------------------
!> $ID:$
!> $Revision: 268 $
!> $Author: dsu $
!> $Date: 2015-01-09 17:00:41 -0800 (Fri, 09 Jan 2015) $
!> $URL: https://biot.eos.ubc.ca/svn/min3p_thcm/branches/dsu_dual_permeability/src/min3p/updtsoil.F90 $
!---------------------------------------------------------------------
!********************************************************************!

!c ----------------------------------------------------------------------
!c subroutine updtsoil
!c -------------------
!c
!c update soil specific parameters (variably saturated flow) 
!c
!c written by:      Uli Mayer - July 27, 01
!c
!c last modified:   Uli Mayer - Nov. 28, 01
!c                  added potential soil evaporation and
!c                  canopy interception
!c
!c definition of variables:
!c
!c I --> on input   * arbitrary  - initialized  + entries expected
!c O --> on output  * arbitrary  - unaltered    + altered
!c 
!c                                                                    I O
!c passed:   -
!c
!c common:   
!c gen.f:    real*8:
!c           -------
!c           pet                = potential evapotranspiration        * +
!c           pe_soil            = potential soil evaporation          * +
!c           canopy_int         = canopy interception                 * +
!c           qroot_tot_max      = max. tree transpiration             * +
!c           sec_per_days       = conversion factor from SI input     + -
!c                                units for physico-chemical 
!c                                parameters internal time units      
!c           tfinal             = final solution time                 + -
!c           time_factor        = conversion factor from I/O time     + -
!c                                units to internal time units
!c           time_io            = current solution time (I/O units)   + -
!c           time_soi           = next read time for soil specific    * +
!c                                parameters
!c           
!c
!c           integer*4:
!c           ----------
!c           ilog               = unit number - logbok file           + -
!c           isoi               = unit number - soil specific         + - 
!c                                parameters
!c
!c phys.f:   real*8:
!c           -------
!c           tree_trans_factor(nzn) = tree transpiration factor       + -
!c           canopy_evap_factor(nzn) = canopy evaporation factor      + -
!c
!c local:    real*8:
!c           -------
!c           tiny               = small increment
!c
!c external: -
!c ----------------------------------------------------------------------
 
      subroutine updtsoil
 
      use parm
      use gen
      use phys
#ifdef PETSC
      use petsc_mpi_common, only : petsc_mpi_finalize
#endif


      implicit none
      
      real*8 :: qroot_tot_max

      real*8, parameter :: tiny = 1.d-10

      if (time_io.gt.time_soi-tiny) then

!c  read next dataset for soil specific parameters
 
        read(isoi,*,err=998,end=997) time_soi, pet, pe_soil,          &
     &                               canopy_int
      pet = pet*sec_per_days
      pe_soil = pe_soil*sec_per_days
      canopy_int = canopy_int*sec_per_days
      qroot_tot_max = tree_trans_factor(1) * pet                    &
     &                - canopy_int/canopy_evap_factor(1)
      
        return

!c  assign next read time greater than final solution time, if no more
!c  read times left and return

997     time_soi = 1.1d0*tfinal/time_factor
        return

998     continue
        if (rank == 0) then
          write(ilog,*) 'SIMULATION TERMINATED' 
          write(ilog,*) 'error reading file ', prefix(:l_prfx)//'.soi'
          close(ilog)
        end if
#ifdef PETSC
        call petsc_mpi_finalize
#endif
        stop

      end if

    return

      end
